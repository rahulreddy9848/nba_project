<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GameTrack â€” Charts</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <link rel="stylesheet" href="/static/chart.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav id="navbar">
        <div id="nav-left">
            <a href="/"><img src="/static/logo.png" id="nav-logo" alt="GameTrack Logo" onerror="this.src='https://placehold.co/40x40/333/FFF?text=GT'"/></a>
            <span id="nav-title">GameTrack</span>
        </div>
        <div id="nav-right">
            <a href="/" class="nav-link">Home</a>
            <a href="/teams" class="nav-link">Teams</a>
            <a class="nav-link active">Charts</a>
        </div>
    </nav>

    <main id="main-content">
        <h1 class="page-title">GameTrack Analytics</h1>

        <section class="chart-section">
            <h2>Top 10 Scorers (PTS)</h2>
            <canvas id="ptsChart"></canvas>
        </section>

        <section class="chart-section">
            <h2>Top 10 Rebounding Teams</h2>
            <canvas id="teamRebChart"></canvas>
        </section>

        <section class="chart-section">
            <h2>Player Comparison</h2>
            <div class="compare-bar">
                <input id="playerA" class="compare-input" placeholder="Player ID A (e.g. 2544)">
                <input id="playerB" class="compare-input" placeholder="Player ID B (e.g. 201939)">
                <button onclick="loadPlayerComparison()" class="compare-btn">Compare</button>
            </div>
    <div id="compare-container"></div>        
</section>
    </main>

<script>
async function loadTopScorers() {
    try {
        const res = await fetch("/api/leaders/PTS");
        const data = await res.json();
        const top10 = (Array.isArray(data) ? data : data.slice ? data.slice(0,10) : data) || [];
        new Chart(document.getElementById("ptsChart"), {
            type: 'bar',
            data: {
                labels: top10.map(p => p.PLAYER || p.PLAYER_NAME || p.player),
                datasets: [{ label: "Points", data: top10.map(p => p.PTS || p.pts || p.PTS_PER_G || 0), backgroundColor: "#1d428a" }]
            },
            options: { responsive:true, plugins:{legend:{display:false}}, scales:{ x:{ ticks:{ color:"#fff"}}, y:{ ticks:{ color:"#fff"} } } }
        });
    } catch (e) { console.error(e); }
}

async function loadTeamRebounds() {
    try {
        const res = await fetch("/api/leaders/REB");
        const players = await res.json();
        const teamMap = {};
        (players || []).forEach(p => {
            const team = p.TEAM || p.abbreviation || p.team || '';
            const reb = Number(p.REB || p.reb || 0);
            teamMap[team] = (teamMap[team] || 0) + reb;
        });
        const entries = Object.entries(teamMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
        new Chart(document.getElementById("teamRebChart"), {
            type: 'bar',
            data: { labels: entries.map(e=>e[0]), datasets:[{label:"REB", data:entries.map(e=>e[1]), backgroundColor:"#c8102e"}] },
            options: { responsive:true, plugins:{legend:{display:false}}, scales:{ x:{ ticks:{ color:"#fff"}}, y:{ ticks:{ color:"#fff"} } } }
        });
    } catch (e) { console.error(e); }
}

async function loadPlayerComparison() {
    const A_id = document.getElementById("playerA").value.trim();
    const B_id = document.getElementById("playerB").value.trim();
    const container = document.getElementById("compare-container");
    
    if (!A_id || !B_id) { 
        alert("Enter two valid player IDs."); 
        return; 
    }
    container.innerHTML = `<p class="loading" style="text-align:center; padding: 20px;">Comparing players...</p>`;

    try {
        const [aRes, bRes] = await Promise.all([
            fetch(`/api/player/${A_id}/profile`), 
            fetch(`/api/player/${B_id}/profile`)
        ]);
        const [aData, bData] = await Promise.all([aRes.json(), bRes.json()]);
        
        const a = aData.info && aData.info[0] ? aData.info[0] : null;
        const b = bData.info && bData.info[0] ? bData.info[0] : null;

        if (!a || !b) { 
            alert("Invalid Player ID(s)."); 
            container.innerHTML = `<p class="error" style="text-align:center;">Failed to load one or both players.</p>`;
            return; 
        }

        const aHeadshot = `https://cdn.nba.com/headshots/nba/latest/1040x760/${a.PERSON_ID}.png`;
        const bHeadshot = `https://cdn.nba.com/headshots/nba/latest/1040x760/${b.PERSON_ID}.png`;

        // Helper function to build a stat row (3 list items)
        // inverse=true means a LOWER number is better (e.g., Turnovers)
        function buildStatRow(statName, a_val, b_val, isInverse = false) {
            let a_class = '';
            let b_class = '';
            
            // Convert to numbers for comparison
            const a_num = parseFloat(a_val);
            const b_num = parseFloat(b_val);
            
            if (a_num > b_num) {
                a_class = isInverse ? 'stat-worse' : 'stat-better';
                b_class = isInverse ? 'stat-better' : 'stat-worse';
            } else if (b_num > a_num) {
                b_class = isInverse ? 'stat-worse' : 'stat-better';
                a_class = isInverse ? 'stat-better' : 'stat-worse';
            }
            
            // Format percentages and round others
            let a_display = a_val;
            let b_display = b_val;
            
            if (statName.includes('%')) {
                a_display = (a_num * 100).toFixed(1) + '%';
                b_display = (b_num * 100).toFixed(1) + '%';
            } else if (statName !== 'PTS') { // Keep PTS as is (e.g., 34.9)
                 a_display = a_num.toFixed(1);
                 b_display = b_num.toFixed(1);
            }

            return `
                <li><span class="${a_class}">${a_display}</span></li>
                <li class="stat-label">${statName}</li>
                <li><span class="${b_class}">${b_display}</span></li>
            `;
        }

        // Build the HTML
        container.innerHTML = `
            <div class="compare-grid">
                <div class="compare-card">
                    <img src="${aHeadshot}" class="compare-headshot" onerror="this.src='/static/logo.png'">
                    <h3>${a.DISPLAY_FIRST_LAST || 'Player A'}</h3>
                </div>
                
                <div class="compare-card">
                    <img src="${bHeadshot}" class="compare-headshot" onerror="this.src='/static/logo.png'">
                    <h3>${b.DISPLAY_FIRST_LAST || 'Player B'}</h3>
                </div>
            </div>

            <ul class="compare-stats-table">
                ${buildStatRow('PTS', a.PTS || 0, b.PTS || 0)}
                ${buildStatRow('REB', a.REB || 0, b.REB || 0)}
                ${buildStatRow('AST', a.AST || 0, b.AST || 0)}
                ${buildStatRow('STL', a.STL || 0, b.STL || 0)}
                ${buildStatRow('BLK', a.BLK || 0, b.BLK || 0)}
                ${buildStatRow('TOV', a.TOV || 0, b.TOV || 0, true)} 
                ${buildStatRow('FG%', a.FG_PCT || 0, b.FG_PCT || 0)}
                ${buildStatRow('3P%', a.FG3_PCT || 0, b.FG3_PCT || 0)}
                ${buildStatRow('FT%', a.FT_PCT || 0, b.FT_PCT || 0)}
            </ul>
        `;

    } catch (e) { 
        console.error(e); 
        alert("Failed to load player data."); 
        container.innerHTML = `<p class="error" style="text-align:center;">Failed to load comparison.</p>`;
    }
}

loadTopScorers();
loadTeamRebounds();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title id="page-title">GameTrack — Team</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav id="navbar">
        <div id="nav-left">
            <a href="/"><img src="https://placehold.co/40x40/007bff/FFF?text=GT" id="nav-logo" alt="GameTrack Logo"/></a>
            <span id="nav-title">GameTrack</span>
        </div>
        <div id="nav-right">
            <a href="/" class="nav-link">Home</a>
            <a href="/teams" class="nav-link active">Teams</a>
            <a href="/charts" class="nav-link">Charts</a>
        </div>
    </nav>

    <main id="main-content" style="max-width: 1400px; margin: 0 auto; padding: 0 25px;">
        <div class="back-button" onclick="history.back()">← Back</div>
        <h1 id="team-name" class="page-title">Loading...</h1>

        <div class="detail-grid">
            <div class="detail-panel panel">
                <h2>Roster</h2>
                <div id="roster-table" class="table-container">
                    <p class="loading">Loading roster...</p>
                </div>
            </div>

            <div class="detail-panel panel">
                <h2>Schedule</h2>
                <!-- NEW: Added titles for clarity -->
                <h3 style="margin-top: 15px; color: #ccc;">Upcoming Games</h3>
                <div id="upcoming-table" class="table-container">
                    <p class="loading">Loading...</p>
                </div>
                <h3 style="margin-top: 25px; color: #ccc;">Recent Results</h3>
                <div id="recent-table" class="table-container" style="margin-top:10px;">
                    <p class="loading">Loading...</p>
                </div>
            </div>
        </div>
    </main>

<!-- *** THIS SCRIPT WAS MISSING *** -->
<script>
    // extract team id from path: /team/<id>
    const teamId = window.location.pathname.split("/").pop();

    async function loadTeam() {
        const nameEl = document.getElementById("team-name");
        const rosterBox = document.getElementById("roster-table");
        const upcomingBox = document.getElementById("upcoming-table");
        const recentBox = document.getElementById("recent-table");

        try {
            // First, get all teams to find the name
            const tRes = await fetch("/api/teams");
            const allTeams = await tRes.json();
            const team = allTeams.find(t => String(t.id) === String(teamId));
            if (team) {
                nameEl.textContent = team.full_name;
                document.getElementById("page-title").textContent = team.full_name + " - Team Page";
            }

            // Then, fetch roster
            const rRes = await fetch(`/api/team/${teamId}/roster`);
            const roster = await rRes.json();
            rosterBox.innerHTML = buildRosterTable(roster);

            // Finally, fetch schedule
            const sRes = await fetch(`/api/team/${teamId}/schedule`);
            const schedule = await sRes.json();
            upcomingBox.innerHTML = buildScheduleTable(schedule.upcoming || [], false);
            recentBox.innerHTML = buildScheduleTable(schedule.recent || [], true);

        } catch (err) {
            console.error(err);
            nameEl.textContent = "Error Loading Team";
            rosterBox.innerHTML = `<p class="error">Failed to load team data.</p>`;
            upcomingBox.innerHTML = `<p class="error">Failed to load schedule.</p>`;
            recentBox.innerHTML = `<p class="error">Failed to load schedule.</p>`;
        }
    }

    function buildRosterTable(data) {
        if (!data || data.length === 0) return "<p>No roster available.</p>";
        // --- FIX: Removed AGE from header ---
        let html = `<table><thead><tr><th>#</th><th>PLAYER</th><th>POS</th><th>HEIGHT</th><th>WEIGHT</th><th>SCHOOL</th></tr></thead><tbody>`;
        data.forEach(p => {
            html += `
                <tr onclick="window.location.href='/player/${p.PLAYER_ID || p.personId || p.PERSON_ID}'" class="clickable-row">
                    <td>${p.NUM || p.JERSEY || ''}</td>
                    <td>${p.PLAYER || p.player || p.DISPLAY_FIRST_LAST || ''}</td>
                    <td>${p.POSITION || p.position || ''}</td>
                    <!-- --- FIX: Removed AGE from cell --- -->
                    <td>${p.HEIGHT || ''}</td>
                    <td>${p.WEIGHT || ''}</td>
                    <td>${p.SCHOOL || p.college || "—"}</td>
                </tr>`;
        });
        html += "</tbody></table>";
        return html;
    }

    function buildScheduleTable(games, isRecent) {
        if (!games || games.length === 0) {
            // --- FIX: More specific messages ---
            return isRecent ? "<p>No recent games found.</p>" : "<p>No upcoming games scheduled.</p>";
        }
        
        let html = `<table><thead><tr><th>Date</th><th>Matchup</th><th>Result</th></tr></thead><tbody>`;
        games.forEach(g => {
            const gameId = g.GAME_ID || g.gameId;
            // --- FIX: Allow clicking on recent games to see box score ---
            const rowClick = isRecent && gameId ? `onclick="window.location.href='/game/${gameId}'"` : "";
            const rowClass = isRecent && gameId ? "clickable-row" : "";
            const title = isRecent && gameId ? "View Box Score" : "";
            const gameDate = new Date(g.GAME_DATETIME || g.GAME_DATE || g.startTimeUTC || '').toLocaleDateString();

            // --- FIX: Show score for recent games ---
            let resultHtml = 'TBD';
            if (isRecent) {
                if (g.PTS !== undefined && g.OPP_PTS !== undefined) {
                    resultHtml = `<strong>${g.WL || ''}</strong> ${g.PTS} - ${g.OPP_PTS}`;
                } else {
                    resultHtml = g.WL || 'Finished'; // Fallback
                }
            }

            html += `<tr class="${rowClass}" ${rowClick} title="${title}">
                        <td>${gameDate}</td>
                        <td>${g.MATCHUP || g.matchup || ''}</td>
                        <td>${resultHtml}</td>
                     </tr>`;
        });
        html += "</tbody></table>";
        return html;
    }

    loadTeam();
</script>
</body>
</html>